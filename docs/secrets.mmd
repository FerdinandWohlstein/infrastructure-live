sequenceDiagram
    autonumber
    participant Dev as DevOps Engineer
    participant Git as GitHub Repository
    participant AWS as AWS KMS (Root of Trust)
    participant TF as Terraform (IaC)
    participant Vault as HashiCorp Vault (Host-Level)
    participant ESO as External Secrets Operator (K3s)
    participant App as Application Pod (K3s)

    Note over Dev, Git: Phase 1: Infrastructure Bootstrap

    Dev->>AWS: Create Customer Managed Key (CMK)
    Dev->>Dev: Encrypt VPS credentials using SOPS with KMS
    Dev->>Git: Push encrypted secrets file (secrets.enc.yaml)

    Note over Git, TF: CI/CD Pipeline Execution

    Git->>TF: Trigger Terraform plan/apply via CI/CD
    TF->>AWS: Request decryption of encrypted payload
    AWS-->>TF: Return plaintext credentials (secure channel)
    TF->>Vault: Provision and configure Vault on host

    Note over Vault, App: Phase 2: Application Secret Management

    Dev->>Vault: Store application secrets via Ansible (e.g., DB_PASSWORD)
    ESO->>Vault: Authenticate using Kubernetes ServiceAccount
    Vault-->>ESO: Return secret value (TLS-encrypted)
    ESO->>ESO: Create native Kubernetes Secret object
    App->>ESO: Mount Kubernetes Secret as environment variable

    Note over App: Phase 3: Runtime Security (Zero Trust)

    participant Cilium as Cilium CNI
    Cilium->>App: Enforce network policies for authorized secret access

    Note over Dev, App: Security Controls
    Note right of AWS: Key rotation enabled - IAM least privilege
    Note right of Vault: Audit logging - Secret versioning - Access policies
    Note right of ESO: RBAC restricted - Namespace isolation
    Cilium->>App: Enforce network policies for authorized secret access
