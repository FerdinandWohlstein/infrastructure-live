sequenceDiagram
    autonumber
    participant Dev as DevOps Engineer
    participant Git as GitHub Repository
    participant AWS as AWS KMS (Root of Trust)
    participant TF as Terraform (IaC)
    participant Ansible as Ansible Playbook
    participant Vault as HashiCorp Vault (Host-Level)
    participant API as Kubernetes API (K3s)
    participant App as Application Pod (K3s)

    Note over Dev, Git: Phase 1: Infrastructure Bootstrap

    Dev->>AWS: Create Customer Managed Key (CMK)
    Dev->>Dev: Encrypt VPS credentials using SOPS with KMS
    Dev->>Git: Push encrypted secrets file (secrets.enc.yaml)

    Note over Git, TF: CI/CD Pipeline Execution

    Git->>TF: Trigger Terraform plan/apply via CI/CD
    TF->>AWS: Request decryption of encrypted payload
    AWS-->>TF: Return plaintext credentials (secure channel)
    TF->>Vault: Provision and configure Vault on host

    Note over Vault, App: Phase 2: Configuration and Secret Distribution

    Dev->>Ansible: Run site.yml with SOPS-encrypted vars
    Ansible->>Vault: Configure Vault service and policies
    Ansible->>API: Apply decrypted kubernetes-secrets.sops.yaml
    API-->>App: Mount native Kubernetes Secret as env/volume

    Note over App: Phase 3: Runtime Security (Zero Trust)

    Note over Dev, App: Security Controls
    Note right of AWS: Key rotation enabled - IAM least privilege
    Note right of Vault: Audit logging - Secret versioning - Access policies
    Note right of API: RBAC + namespace scoping for secret access
