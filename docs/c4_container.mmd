graph TB
    %% C4 Container View - wording
    subgraph Deployment_Node [Deployment Node: Single VPS]
        direction TB

        subgraph System_Boundary [Software System: Self-Hosted Platform]
            direction TB

            subgraph Edge_Security [Containers: Edge and Access]
                WG[Container: WireGuard VPN
                ISO 27001: A.9.2.1]
                Ingress[Container: Traefik Ingress]
                CM[Container: cert-manager
                ACME TLS]
            end

            %% Host-level services (not running on Kubernetes)
            subgraph Host_Services [Containers: Host-level Services
            Not on Kubernetes]
                Vault[(Container: HashiCorp Vault
                Secrets Management
                ISO 27001: A.10.1)]
            end

            subgraph K3s_Cluster [Container: K3s Cluster
            Single-Node First]
                direction TB

                subgraph Node [Container: K3s Node
                Control Plane and Worker]
                    API[Container: Kubernetes API Server]
                    Argo[Container: Argo CD
                    GitOps
                    ISO 27001: A.12.1.2]

                    subgraph Networking [Container: CNI and Networking]
                        Flannel[Container: K3s Flannel
                        Pod Networking
                        ISO 27001: A.13.1.1]
                    end

                    subgraph Platform [Containers: Platform Services]
                        Blocky[Container: Blocky DNS
                        DNS sinkhole and filtering]
                    end

                    subgraph Runtime_Workloads [Containers: Workloads]
                        App[Container: Nginx Test App]
                        Obs[Container: Observability
                            kube-prometheus-stack
                            Loki / Tempo / Mimir / Promtail]
                    end
                end
            end

            subgraph Persistence [Containers: Persistence and State]
                DS[(Container: K3s Datastore
                SQLite current single-node)]
            end
        end
    end

    subgraph External [External System: Object Storage
    Low-Cost]
        Obj[(External System: S3-Compatible Object Storage
        Backups / Artifacts)]
    end

    %% Key Relationships (intent)
    WG -- "Admin access" --> API
    Ingress -- "Public traffic HTTPS" --> App
    CM -- "Issues/Renews certs" --> Ingress

    API -- "State" --> DS

    Argo -- "Applies desired state" --> Runtime_Workloads
    Argo -- "Deploys chart and values" --> Blocky
    Flannel -- "Pod networking" --> Runtime_Workloads

    DS -- "Backups
    ISO 27001: A.17.1.2" --> Obj
    Vault -- "Backups or snapshots
    ISO 27001: A.17.1.2" --> Obj
    Obs -- "Export/Backups optional" --> Obj

    %% Styling for Clarity
    classDef edge fill:#fff3e0,stroke:#ef6c00,color:#e65100;
    classDef cluster fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#003b6f;
    classDef persistence fill:#f5f5f5,stroke:#616161,color:#212121;
    classDef external fill:#e8eaf6,stroke:#3949ab,color:#1a237e,stroke-dasharray: 5 5;
    classDef workload fill:#e8f5e9,stroke:#2e7d32,color:#1b5e20;

    class Edge_Security edge;
    class K3s_Cluster cluster;
    class Persistence persistence;
    class External external;
    class App,Obs,Blocky workload;
