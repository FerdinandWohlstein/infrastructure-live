---
# UFW Firewall configuration tasks

- name: Configure UFW - Allow SSH
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: Configure UFW - Allow HTTP
  community.general.ufw:
    rule: allow
    port: "80"
    proto: tcp

- name: Configure UFW - Allow HTTPS
  community.general.ufw:
    rule: allow
    port: "443"
    proto: tcp

- name: Allow WireGuard UDP Tunnel
  community.general.ufw:
    rule: allow
    port: "{{ wireguard_listen_port }}"
    proto: udp

- name: Remove conflicting K3s API deny rule
  community.general.ufw:
    rule: deny
    port: "6443"
    proto: tcp
    delete: true
  failed_when: false

- name: Allow all traffic from WireGuard interface
  community.general.ufw:
    rule: allow
    direction: in
    interface: wg0

# Kubernetes cluster networking - Allow pod and service networks
- name: Allow traffic from pod network (cluster-cidr)
  community.general.ufw:
    rule: allow
    from_ip: "{{ k3s_cluster_cidr }}"

- name: Allow traffic from service network (service-cidr)
  community.general.ufw:
    rule: allow
    from_ip: "{{ k3s_service_cidr }}"

# Kubernetes routing - Allow forwarding between networks
- name: Allow routing from pod network
  community.general.ufw:
    rule: allow
    route: true
    from_ip: "{{ k3s_cluster_cidr }}"

- name: Allow routing from service network
  community.general.ufw:
    rule: allow
    route: true
    from_ip: "{{ k3s_service_cidr }}"

- name: Allow routing to pod network
  community.general.ufw:
    rule: allow
    route: true
    to_ip: "{{ k3s_cluster_cidr }}"

- name: Allow routing to service network
  community.general.ufw:
    rule: allow
    route: true
    to_ip: "{{ k3s_service_cidr }}"

- name: Set default forward policy to ACCEPT for Kubernetes
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
  notify: Reload UFW

- name: Allow ICMP (Ping) via ufw before.rules
  ansible.builtin.blockinfile:
    path: /etc/ufw/before.rules
    marker: "# {mark} ANSIBLE MANAGED - Allow ICMP"
    insertafter: "# ok icmp codes for INPUT"
    block: |
      -A ufw-before-input -p icmp --icmp-type echo-request -j ACCEPT
  notify: Reload UFW

- name: Enable UFW with default deny policy
  community.general.ufw:
    state: enabled
    policy: deny
