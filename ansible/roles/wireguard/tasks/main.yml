---
- name: Verify WireGuard secrets are present
  ansible.builtin.assert:
    that:
      - wireguard_private_key is defined
      - wireguard_peers is defined
    fail_msg: "WireGuard configuration variables are missing. Ensure the encrypted secrets file is correctly loaded."

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: true
    state: present
    reload: true

- name: Create WireGuard configuration
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: /etc/wireguard/{{ wireguard_interface }}.conf
    mode: '0600'
  no_log: true
  notify: Restart WireGuard

- name: Ensure WireGuard is started and enabled
  ansible.builtin.service:
    name: wg-quick@{{ wireguard_interface }}
    state: started
    enabled: true

- name: Disable Reverse Path Filtering for WireGuard interface
  ansible.posix.sysctl:
    name: net.ipv4.conf.{{ wireguard_interface }}.rp_filter
    value: '0'
    state: present
    reload: true
