---
# K3s installation tasks

- name: Install K3s
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server \
      --tls-san {{ ansible_host }} \
      --tls-san {{ public_ip | default(ansible_host) }} \
      --tls-san {{ k3s_advertise_address }}" sh -
  args:
    creates: /usr/local/bin/k3s
  register: k3s_install
  when: not k3s_binary.stat.exists or k3s_force_reinstall

- name: Ensure K3s service is started
  ansible.builtin.systemd:
    name: k3s
    state: started
    enabled: true
  register: k3s_start
  retries: 3
  delay: 5
  until: k3s_start is succeeded

- name: Wait for K3s API to be ready
  ansible.builtin.wait_for:
    port: 6443
    host: 127.0.0.1
    delay: 5
    timeout: 120

- name: Wait for K3s to be ready
  ansible.builtin.command: k3s kubectl get nodes
  register: nodes
  until: nodes.rc == 0
  retries: 10
  delay: 5
  changed_when: false
