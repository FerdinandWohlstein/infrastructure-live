---
# ArgoCD deployment tasks

- name: Verify ArgoCD secrets are present
  ansible.builtin.assert:
    that:
      - repo_url is defined
      - github_token is defined
      - github_user is defined
    fail_msg: "ArgoCD Git credentials are missing. Ensure the encrypted secrets file is correctly loaded."

- name: Create ArgoCD Namespace
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    kind: Namespace
    name: "{{ k3s_argocd_namespace }}"
    state: present

- name: Install ArgoCD via Manifest
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    namespace: "{{ k3s_argocd_namespace }}"
    src: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    state: present

- name: Wait for ArgoCD CRDs to be ready
  ansible.builtin.command: k3s kubectl wait --for=condition=established --timeout=60s crd/applications.argoproj.io
  changed_when: false
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Create ArgoCD Git Credentials Secret
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
        name: github-repo-credentials
        namespace: "{{ k3s_argocd_namespace }}"
      stringData:
        password: "{{ github_token }}"
        type: git
        url: "{{ repo_url }}"
        username: "{{ github_user }}"
    state: present
  no_log: true

- name: Decrypt and Apply ArgoCD Secrets
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    definition: "{{ lookup('community.sops.sops', playbook_dir + '/argocd.sops.yaml') | from_yaml_all | list }}"
    namespace: "{{ k3s_argocd_namespace }}"
    state: present
  no_log: true

- name: Create Observability Namespace
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        annotations:
          argocd.argoproj.io/sync-wave: "-1"
        name: observability
    state: present

- name: Apply Kubernetes Component Secrets
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    definition: "{{ lookup('community.sops.sops', playbook_dir + '/../kubernetes/kubernetes-secrets.sops.yaml') | from_yaml_all | list }}"
    state: present
  no_log: true

- name: Apply ArgoCD Root Application
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  kubernetes.core.k8s:
    definition: "{{ lookup('ansible.builtin.template', playbook_dir + '/../kubernetes/bootstrap/root.yaml') | from_yaml }}"
    namespace: "{{ k3s_argocd_namespace }}"
    state: present
